<!DOCTYPE html>
<html lang="en">
	<head>
		<meta charset="UTF-8" />
		<meta name="viewport" content="width=device-width, initial-scale=1.0"/>
		<title>Admin | Family Values Group</title>
		<link rel="stylesheet" href="styles/agentstyle.css" />
		<link rel="stylesheet" href="styles/admin.css" />
		<link href="https://fonts.googleapis.com/css?family=Bellota+Text" rel="stylesheet" />
		<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.0/css/all.min.css" />
		<link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/choices.js/public/assets/styles/choices.min.css" />
  		<link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/flatpickr/dist/flatpickr.min.css" />
	</head>
	
	<body id="dashboardbody">
		
		<!-- Header -->
		<header class="index-grid-header">
			<div id="logofvcontainer">
				<div id="logodiv">
					<a href="../index.html"><img id="headerlogo" src="../Pics/img17.png" alt="FVIA Logo" /></a>
				</div>
				<div id="fvdiv">
					<p><strong>Family Values Group</strong></p>
				</div>
			</div>
			<div id="navcontainer">
				<nav class="header-flex-container">
					<a id="notifications-tab" href="notifications.html"><i class="fa-solid fa-bell"></i></a>
					<a id="profile-tab" href="profile.html"><i class="fa-solid fa-user"></i></a>
					<div id="menu-toggle">
						<i class="fa-solid fa-bars"></i>
					</div>
				</nav>
			</div>
		</header>

		<!-- Mobile Menu -->
		<div id="mobile-menu">
			<a href="dashboard.html"><i class="fa-solid fa-gauge"></i><p>Dashboard</p></a>
			
			<!-- Toolkit parent (acts like a toggle, not a link) -->
			<button id="toolkit-toggle" class="menu-item" aria-expanded="false" aria-controls="toolkit-submenu">
				<i class="fa-solid fa-toolbox"></i><span>Toolkit</span>
				<i class="fa-solid fa-chevron-down caret" aria-hidden="true"></i>
			</button>
			
			<!-- Submenu that expands between Toolkit and Commissions -->
			<div id="toolkit-submenu" class="submenu" hidden>
				<a href="leads.html"><i class="fa-solid fa-address-book"></i><span>Leads</span></a>
				<a href="maps.html"><i class="fa-solid fa-route"></i><span>Routing</span></a>
				<a href="scheduling.html"><i class="fa-solid fa-calendar-check"></i><span>Scheduling</span></a>
				<a href="calendar.html"><i class="fa-solid fa-calendar-days"></i><span>Calendar</span></a>
			</div>
			<a href="commissions.html"><i class="fa-solid fa-dollar-sign"></i><p>Commissions</p></a>
			<a href="training.html"><i class="fa-solid fa-chalkboard-teacher"></i><p>Training</p></a>
			<a href="recruiting.html"><i class="fa-solid fa-user-plus"></i><p>Recruiting</p></a>
			<a href="messages.html"><i class="fa-solid fa-envelope"></i><p>Messages</p></a>
			<a href="admin.html"><i class="fa-solid fa-user-shield"></i><p>Admin</p></a>
		</div>
    
  <main class="auth-container">
    
    <!-- Admin page navigation -->
    <nav id="admin-page-nav">
      <button id="nav-all" class="active">All Leads</button>
      <button id="nav-requests">Lead Requests</button>
      <button id="nav-history">Assignment History</button>
      <button id="nav-stats">Agent Stats</button>
    </nav>
    <!-- Lead Requests Section -->
    <section id="admin-requests-section" class="admin-section" style="display:none;">
      <h3>Lead Requests</h3>
      <div id="requested-leads-container" class="scroll-container"></div>
      <hr />
    </section>
    <!-- Leads Table -->
    <section id="admin-all-section" class="admin-section">
      <h3>All Leads</h3>
      <!-- Filters -->
      <div id="admin-all-container">
        <div id="admin-filters" class="filter-wrapper">
          <div class="filter-group">
            <label for="date-range">Date Range</label>
            <input id="date-range" placeholder="Select date range" readonly />
          </div>
          <div class="filter-group">
            <label for="date-order">Order</label>
            <select id="date-order">
              <option value="desc">Most Recent</option>
              <option value="asc">Oldest</option>
            </select>
          </div>
          <div class="filter-group">
            <label for="agent-filter">Agent</label>
            <select id="agent-filter">
              <option value="">All Agents</option>
              <!-- options populated by script -->
            </select>
          </div>
          <div class="filter-group">
            <label for="assigned-filter">Assigned</label>
            <select id="assigned-filter">
              <option value="">Assigned &amp; Unassigned</option>
              <option value="true">Assigned</option>
              <option value="false">Unassigned</option>
            </select>
          </div>
          <div class="filter-group">
            <label for="zip-filter">ZIP</label>
            <input type="text" id="zip-filter" placeholder="ZIP" />
          </div>
          <div class="filter-group">
            <label for="city-filter">City</label>
            <input type="text" id="city-filter" placeholder="City" />
          </div>
          <div class="filter-group">
            <label for="state-filter">State</label>
            <select id="state-filter">
              <option value="">All States</option>
              <option value="AL">Alabama</option>
              <option value="AK">Alaska</option>
              <option value="AZ">Arizona</option>
              <option value="AR">Arkansas</option>
              <option value="CA">California</option>
              <option value="CO">Colorado</option>
              <option value="CT">Connecticut</option>
              <option value="DE">Delaware</option>
              <option value="FL">Florida</option>
              <option value="GA">Georgia</option>
              <option value="HI">Hawaii</option>
              <option value="ID">Idaho</option>
              <option value="IL">Illinois</option>
              <option value="IN">Indiana</option>
              <option value="IA">Iowa</option>
              <option value="KS">Kansas</option>
              <option value="KY">Kentucky</option>
              <option value="LA">Louisiana</option>
              <option value="ME">Maine</option>
              <option value="MD">Maryland</option>
              <option value="MA">Massachusetts</option>
              <option value="MI">Michigan</option>
              <option value="MN">Minnesota</option>
              <option value="MS">Mississippi</option>
              <option value="MO">Missouri</option>
              <option value="MT">Montana</option>
              <option value="NE">Nebraska</option>
              <option value="NV">Nevada</option>
              <option value="NH">New Hampshire</option>
              <option value="NJ">New Jersey</option>
              <option value="NM">New Mexico</option>
              <option value="NY">New York</option>
              <option value="NC">North Carolina</option>
              <option value="ND">North Dakota</option>
              <option value="OH">Ohio</option>
              <option value="OK">Oklahoma</option>
              <option value="OR">Oregon</option>
              <option value="PA">Pennsylvania</option>
              <option value="RI">Rhode Island</option>
              <option value="SC">South Carolina</option>
              <option value="SD">South Dakota</option>
              <option value="TN">Tennessee</option>
              <option value="TX">Texas</option>
              <option value="UT">Utah</option>
              <option value="VT">Vermont</option>
              <option value="VA">Virginia</option>
              <option value="WA">Washington</option>
              <option value="WV">West Virginia</option>
              <option value="WI">Wisconsin</option>
              <option value="WY">Wyoming</option>
            </select>
        </div>
        <div class="filter-group">
          <label for="first-name-filter">First Name</label>
          <input type="text" id="first-name-filter" placeholder="First Name" />
        </div>
        <div class="filter-group">
          <label for="last-name-filter">Last Name</label>
          <input type="text" id="last-name-filter" placeholder="Last Name" />
        </div>
        <div class="filter-group">
          <label for="lead-type-filter">Product Type</label>
          <select id="lead-type-filter">
            <option value="">All Product Types</option>
            <option value="Auto">Life Insurance</option>
            <option value="Home">Health Insurance</option>
            <option value="Life">Property & Casualty Insurance</option>
            <option value="Health">LegalShield/IDShield</option>
            <option value="Other">Realty</option>
          </select>
        </div>

        <div class="filter-buttons">
          <button id="apply-filters">Apply Filters</button>
          <button id="reset-filters">Reset Filters</button>
        </div>
      </div>
        <select id="sort-by" style="display: none;">
          <option value="first_name">first_name</option>
          <option value="last_name">last_name</option>
          <option value="age">age</option>
          <option value="phone">phone</option>
          <option value="address">address</option>
          <option value="city">city</option>
          <option value="state">state</option>
          <option value="zip">zip</option>
          <option value="lead_type">lead_type</option>
          <option value="submitted_by_name">submitted_by_name</option>
          <option value="notes">notes</option>
          <option value="created_at">created_at</option>
        </select>
        <div id="leads-table-container">
          <table id="leads-table">
            <thead>
              <tr>
                <th><input type="checkbox" id="select-all"></th>
                <th data-column="created_at">Submitted</th>
                <th data-column="submitted_by_name">Agent</th>
                <th data-column="first_name">First Name</th>
                <th data-column="last_name">Last Name</th>
                <th data-column="age">Age</th>
                <th data-column="phone">Phone(s)</th>
                <th data-column="address">Address</th>
                <th data-column="city">City</th>
                <th data-column="state">State</th>
                <th data-column="zip">ZIP</th>
                <th data-column="lead_type">Type</th>
                <th data-column="notes">Notes</th>
                <th data-column="product_type">Product</th>
              </tr>
            </thead>
            <tbody>
              <!-- Leads load here -->
            </tbody>
          </table>
          <div id="pagination-controls" style="margin-top: 10px;">
            <button id="prev-page">Previous</button>
            <span id="current-page">Page 1</span>
            <button id="next-page">Next</button>
          </div>
        </div>
        <!-- Bulk Assign Controls -->
        <div id="bulk-export-invisible-container">
          <div id="bulk-export-container">
            <div id="bulk-assign-controls" style="margin-top: 10px;">
              <label for="bulk-assign-agent">Assign <span id="selected-count">0</span> lead(s) to:</label>
              <select id="bulk-assign-agent">
                <!-- populated by script -->
              </select>
              <button id="bulk-assign-btn">Assign</button>
            </div>
            <div id="export-controls" style="position: relative;">
              <button id="export-btn" style="margin: auto">Export</button>
              <div id="export-options" style="display: none; position: absolute; background: white; border: 1px solid #ccc; padding: 5px;">
                <button id="export-pdf">PDF</button>
                <button id="export-csv">CSV</button>
                <button id="export-print">Print</button>
              </div>
            </div>
          </div>
        </div>
      </div>
    </section>

    <!-- Assignment History Section -->
    <section id="admin-history-section" class="admin-section" style="display:none;">
      <h3 style="margin-top: 30px;">Assignment History</h3>
      <table id="assignment-history-table">
        <thead>
          <tr>
            <th>Date</th>
            <th>Lead ID</th>
            <th>Assigned To</th>
            <th>Assigned By</th>
          </tr>
        </thead>
        <tbody>
          <!-- History entries load here -->
        </tbody>
      </table>
    </section>
    <!-- Agent Stats Section -->
    <section id="admin-stats-section" class="admin-section" style="display:none;">
	  <h3>Agent Stats</h3>
	
	  <div class="stats-toolbar">
	    <div class="scope">
		  <label for="stat-agent">Agent</label>
		  <select id="stat-agent">
			<option value="">All agents</option>
			<!-- options filled by JS -->
		  </select>
		</div>
	    <div class="range" style="display:flex; align-items:center; gap:10px;">
		  <!-- flatpickr wrap lets the icon open the calendar -->
		  <div id="stat-range-wrap" class="flatpickr-range" data-wrap="true">
		    <input id="stat-range" type="text" placeholder="Select date range" data-input readonly />
		    <button class="calendar-btn" type="button" title="Choose dates" data-toggle>
		      <i class="fa-solid fa-calendar"></i>
		    </button>
		  </div>
		  <label style="display:flex; align-items:center; gap:6px; white-space:nowrap;">
		    <input type="checkbox" id="stat-all-time"> All time
		  </label>
		</div>
	  </div>
	
	  <div class="kpi-grid">
		<!-- Add these inside your existing KPI grid/cards -->
		<div class="kpi-card">
		  <div class="kpi-label">Contact rate</div>
		  <div class="kpi-value" id="kpi-contact">—</div>
		</div>
		
		<div class="kpi-card">
		  <div class="kpi-label">Quote rate</div>
		  <div class="kpi-value" id="kpi-quote">—</div>
		</div>
		
		<div class="kpi-card">
		  <div class="kpi-label">Close rate</div>
		  <div class="kpi-value" id="kpi-close">—</div>
		</div>
		
		<div class="kpi-card">
		  <div class="kpi-label">
		    Persistency <small>(90-day)</small>
		  </div>
		  <div class="kpi-value" id="kpi-persistency">—</div>
		</div>
	    <article class="kpi-card">
	      <div class="kpi-label">New Leads</div>
	      <div class="kpi-value" id="kpi-new">0</div>
	    </article>
	    <article class="kpi-card">
	      <div class="kpi-label">Assigned</div>
	      <div class="kpi-value" id="kpi-assigned">0</div>
	    </article>
	    <article class="kpi-card">
	      <div class="kpi-label">Avg Age</div>
	      <div class="kpi-value" id="kpi-avg-age">—</div>
	    </article>
	    <article class="kpi-card">
	      <div class="kpi-label">Agents Assigned</div>
	      <div class="kpi-value" id="kpi-agents">0</div>
	    </article>
	  </div>
	
	  <div class="chart-grid">
	    <div class="chart-card">
	      <h4>Weekly New Leads</h4>
	      <canvas id="chart-weekly"></canvas>
	    </div>
	    <div class="chart-card">
	      <h4>Product Mix</h4>
	      <canvas id="chart-products"></canvas>
	    </div>
	    <div class="chart-card">
	      <h4>Assignments by Agent</h4>
	      <canvas id="chart-assignments"></canvas>
	    </div>
	  </div>
	</section>
  </main>
    <!-- Reassignment Warning Modal -->
    <div id="reassign-warning-modal" style="display: none; position: fixed; top: 0; left: 0; width: 100vw; height: 100vh; background: rgba(0,0,0,0.5); z-index: 9999; align-items: center; justify-content: center;">
      <div style="background: white; padding: 20px; border-radius: 10px; max-width: 90vw; width: 300px; text-align: center;">
        <p><strong>Warning!</strong> You are about to re-assign one or more leads. Would you still like to submit?</p>
        <div style="margin-top: 20px;">
          <button id="cancel-reassign-btn" style="margin-right: 10px;">Cancel</button>
          <button id="submit-anyway-btn">Submit Anyway</button>
        </div>
      </div>
    </div>
  <!-- Footer -->
		<footer class="index-grid-footer">
			<img id="footerlogo" src="Pics/img17.png">
			<hr class="footerhr">
			<div id="footercontact">
				<a class="contactcontainer" href="mailto:fvinsuranceagency@gmail.com">
					<span class="fa fa-envelope"></span>
					<span class="contactcontcontacts">fvinsuranceagency@gmail.com</span>
				</a>
				<p> | </p>
				<a class="contactcontainer" href="tel:+17316934739">
					<span href="#" class="fa fa-phone"></span>
					<span class="contactcontcontacts">(731)693-4739</span>
				</a>
			</div>
			<hr class="footerhr">
			<div id="footersocial">
				<a class="fab fa-facebook-f" href="#"></a>
				<a class="fab fa-linkedin-in" href="#"></a>
				<a class="fab fa-instagram" href="#"></a>
				<a class="fab fa-youtube" href="#"></a>
				<a class="fab fa-google" href="#"></a>
			</div>
			<!-- Footer links section (below social icons) -->
			<div id="footerlinks">
				<a href="faqs.html">FAQs</a>
				<a href="terms.html">Terms</a>
				<a href="accessibility.html">Accessibility</a>
				<a href="privacy.html">Privacy</a>
			</div>
			<p><em>© 2025 Family Values Group. All Rights Reserved.</em></p>
		</footer>
		<script src="https://cdn.jsdelivr.net/npm/choices.js/public/assets/scripts/choices.min.js"></script>
		  <script src="https://cdn.jsdelivr.net/npm/flatpickr"></script>
		  <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
		  <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf-autotable/3.5.28/jspdf.plugin.autotable.min.js"></script>
		<script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
		<script type="module" src="scripts/general.js"></script>
		<script type="module" src="scripts/admin.js"></script>
	</body>
	-- =========================================================
-- FVIA CRM CORE SCHEMA (Contacts → Leads → Policies)
-- Safe to run multiple times (guards for duplicates).
-- =========================================================

-- ---------- Helpers
CREATE EXTENSION IF NOT EXISTS "uuid-ossp";
CREATE EXTENSION IF NOT EXISTS pgcrypto;

-- touch updated_at helper
CREATE OR REPLACE FUNCTION public.tg_touch_updated_at()
RETURNS trigger
LANGUAGE plpgsql AS $$
BEGIN
  NEW.updated_at = now();
  RETURN NEW;
END $$;

-- ---------- Lightweight "enum via CHECK" (easier to evolve than real ENUM)
-- If you prefer true ENUMs later, swap these for CREATE TYPE statements.
-- Lead close status
DO $$ BEGIN
  ALTER TABLE IF EXISTS public.leads
    ADD CONSTRAINT leads_closed_status_check
    CHECK (closed_status IN ('open','won','lost'));
EXCEPTION WHEN duplicate_object THEN NULL; END $$;

-- Policy status values
DO $$ BEGIN
  CREATE TABLE IF NOT EXISTS public._policy_status_allowed (val text PRIMARY KEY);
  INSERT INTO public._policy_status_allowed(val) VALUES
    ('pending'),('issued'),('in_force'),('cancelled'),('reinstated'),('lapsed'),('renewed')
  ON CONFLICT DO NOTHING;
END $$;

-- Activity types (for timeline)
DO $$ BEGIN
  CREATE TABLE IF NOT EXISTS public._activity_type_allowed (val text PRIMARY KEY);
  INSERT INTO public._activity_type_allowed(val) VALUES
    ('note'),('call_outbound'),('call_inbound'),('sms'),('email'),('meeting'),
    ('task_created'),('quote_started'),('quote_finalized'),('import_event'),('status_change')
  ON CONFLICT DO NOTHING;
END $$;

-- Policy event types (status history)
DO $$ BEGIN
  CREATE TABLE IF NOT EXISTS public._policy_event_type_allowed (val text PRIMARY KEY);
  INSERT INTO public._policy_event_type_allowed(val) VALUES
    ('submitted'),('issued'),('in_force'),('cancelled'),('reinstated'),('lapsed'),('renewed'),('chargeback'),('other')
  ON CONFLICT DO NOTHING;
END $$;

-- =========================================================
-- CONTACTS
-- =========================================================
CREATE TABLE IF NOT EXISTS public.contacts (
  id               uuid PRIMARY KEY DEFAULT gen_random_uuid(),
  created_at       timestamptz NOT NULL DEFAULT now(),
  updated_at       timestamptz NOT NULL DEFAULT now(),

  -- Identity
  first_name       text,
  last_name        text,
  full_name        text GENERATED ALWAYS AS (
    trim(coalesce(first_name,'') || ' ' || coalesce(last_name,''))
  ) STORED,

  -- Multi-values
  phones           text[] DEFAULT '{}'::text[],
  emails           text[] DEFAULT '{}'::text[],

  -- Address
  address_line1    text,
  address_line2    text,
  city             text,
  state            text,
  zip              text,
  lat              numeric,
  lng              numeric,

  -- Compliance
  consent_source   text,          -- e.g., 'web_form','agent_entry'
  consent_at       timestamptz,
  tcpaconsent      boolean DEFAULT false,
  dnc_flag         boolean DEFAULT false,

  -- Ownership
  owning_agent_id  uuid,          -- maps to your auth.users.id if desired

  metadata         jsonb DEFAULT '{}'::jsonb
);

CREATE INDEX IF NOT EXISTS idx_contacts_name ON public.contacts (full_name);
CREATE INDEX IF NOT EXISTS idx_contacts_phones_gin ON public.contacts USING gin (phones);
CREATE INDEX IF NOT EXISTS idx_contacts_emails_gin ON public.contacts USING gin (emails);

DROP TRIGGER IF EXISTS trg_contacts_touch ON public.contacts;
CREATE TRIGGER trg_contacts_touch
BEFORE UPDATE ON public.contacts
FOR EACH ROW EXECUTE FUNCTION public.tg_touch_updated_at();

-- =========================================================
-- LEADS (augment your existing table, DO NOT drop anything)
-- =========================================================

-- Link leads → contacts
ALTER TABLE public.leads
  ADD COLUMN IF NOT EXISTS contact_id uuid REFERENCES public.contacts(id) ON DELETE SET NULL;

-- Operational stamps
ALTER TABLE public.leads
  ADD COLUMN IF NOT EXISTS contacted_at          timestamptz,
  ADD COLUMN IF NOT EXISTS quoted_at             timestamptz,
  ADD COLUMN IF NOT EXISTS closed_at             timestamptz,
  ADD COLUMN IF NOT EXISTS closed_status         text DEFAULT 'open',
  ADD COLUMN IF NOT EXISTS closed_reason         text,
  ADD COLUMN IF NOT EXISTS first_seen_in_feed_at timestamptz;

-- Helpful indexes
CREATE INDEX IF NOT EXISTS idx_leads_contact_id       ON public.leads (contact_id);
CREATE INDEX IF NOT EXISTS idx_leads_product_type     ON public.leads (product_type);
CREATE INDEX IF NOT EXISTS idx_leads_closed_status    ON public.leads (closed_status);
CREATE INDEX IF NOT EXISTS idx_leads_created_at       ON public.leads (created_at);

-- Enforce allowed closed_status values (uses check added above)
DO $$ BEGIN
  PERFORM 1 FROM information_schema.constraint_column_usage
   WHERE table_schema='public' AND table_name='leads' AND constraint_name='leads_closed_status_check';
  -- If missing, add again (guarded above)
EXCEPTION WHEN OTHERS THEN NULL; END $$;

-- =========================================================
-- POLICIES
-- =========================================================
CREATE TABLE IF NOT EXISTS public.policies (
  id                 uuid PRIMARY KEY DEFAULT gen_random_uuid(),
  created_at         timestamptz NOT NULL DEFAULT now(),
  updated_at         timestamptz NOT NULL DEFAULT now(),

  -- Links
  contact_id         uuid NOT NULL REFERENCES public.contacts(id) ON DELETE CASCADE,
  lead_id            uuid REFERENCES public.leads(id) ON DELETE SET NULL,
  agent_id           uuid,  -- who wrote it (auth.users.id if you like)

  -- Carrier specifics
  carrier_name       text NOT NULL,
  policy_number      text NOT NULL,
  policy_type        text,           -- granular (Homeowners, Final Expense, etc.)
  product_line       text,           -- high-level bucket; align to leads.product_type

  -- Dates & money
  submitted_at       timestamptz,
  issued_at          timestamptz,
  effective_at       timestamptz,
  status             text NOT NULL DEFAULT 'pending',
  premium_modal      numeric,
  premium_annual     numeric,
  currency           text DEFAULT 'USD',

  -- Provenance
  source             text,           -- 'agent_attestation','carrier_feed','imo_feed'
  verification_state text DEFAULT 'unverified',

  metadata           jsonb DEFAULT '{}'::jsonb,

  -- No dupes
  UNIQUE (carrier_name, policy_number),

  -- Status must be one of allowed
  CONSTRAINT policies_status_check
    CHECK (status IN (SELECT val FROM public._policy_status_allowed))
);

CREATE INDEX IF NOT EXISTS idx_policies_contact          ON public.policies (contact_id);
CREATE INDEX IF NOT EXISTS idx_policies_lead             ON public.policies (lead_id);
CREATE INDEX IF NOT EXISTS idx_policies_carrier_polnum   ON public.policies (carrier_name, policy_number);
CREATE INDEX IF NOT EXISTS idx_policies_status           ON public.policies (status);

DROP TRIGGER IF EXISTS trg_policies_touch ON public.policies;
CREATE TRIGGER trg_policies_touch
BEFORE UPDATE ON public.policies
FOR EACH ROW EXECUTE FUNCTION public.tg_touch_updated_at();

-- =========================================================
-- POLICY STATUS HISTORY (events instead of arrays)
-- =========================================================
CREATE TABLE IF NOT EXISTS public.policy_status_history (
  id             bigserial PRIMARY KEY,
  policy_id      uuid NOT NULL REFERENCES public.policies(id) ON DELETE CASCADE,
  event_type     text NOT NULL,
  event_at       timestamptz NOT NULL,
  source         text,              -- 'carrier_feed','imo_feed','manual'
  notes          text,
  payload        jsonb DEFAULT '{}'::jsonb,

  CONSTRAINT psh_event_type_check
    CHECK (event_type IN (SELECT val FROM public._policy_event_type_allowed))
);

CREATE INDEX IF NOT EXISTS idx_psh_policy   ON public.policy_status_history (policy_id);
CREATE INDEX IF NOT EXISTS idx_psh_event_at ON public.policy_status_history (event_at);

-- =========================================================
-- ACTIVITIES (unified timeline across contact/lead/policy)
-- =========================================================
CREATE TABLE IF NOT EXISTS public.activities (
  id             bigserial PRIMARY KEY,
  created_at     timestamptz NOT NULL DEFAULT now(),

  contact_id     uuid NOT NULL REFERENCES public.contacts(id) ON DELETE CASCADE,
  lead_id        uuid REFERENCES public.leads(id) ON DELETE SET NULL,
  policy_id      uuid REFERENCES public.policies(id) ON DELETE SET NULL,

  actor_user_id  uuid,              -- agent/admin who did it (optional)
  kind           text NOT NULL,
  summary        text,
  details        text,
  metadata       jsonb DEFAULT '{}'::jsonb,

  CONSTRAINT activities_kind_check
    CHECK (kind IN (SELECT val FROM public._activity_type_allowed))
);

CREATE INDEX IF NOT EXISTS idx_acts_contact ON public.activities (contact_id);
CREATE INDEX IF NOT EXISTS idx_acts_lead    ON public.activities (lead_id);
CREATE INDEX IF NOT EXISTS idx_acts_policy  ON public.activities (policy_id);
CREATE INDEX IF NOT EXISTS idx_acts_kind    ON public.activities (kind);

-- =========================================================
-- ASSIGNMENT HISTORY (who owned what, when)
-- =========================================================
CREATE TABLE IF NOT EXISTS public.assignments (
  id             bigserial PRIMARY KEY,
  created_at     timestamptz NOT NULL DEFAULT now(),

  target_type    text NOT NULL CHECK (target_type IN ('contact','lead','policy')),
  contact_id     uuid REFERENCES public.contacts(id) ON DELETE CASCADE,
  lead_id        uuid REFERENCES public.leads(id) ON DELETE CASCADE,
  policy_id      uuid REFERENCES public.policies(id) ON DELETE CASCADE,

  assigned_to    uuid NOT NULL,  -- agent/user id
  assigned_by    uuid,
  reason         text
);

CREATE INDEX IF NOT EXISTS idx_assign_contact ON public.assignments (contact_id);
CREATE INDEX IF NOT EXISTS idx_assign_lead    ON public.assignments (lead_id);
CREATE INDEX IF NOT EXISTS idx_assign_policy  ON public.assignments (policy_id);

-- =========================================================
-- TASKS / SCHEDULING (appointments & reminders)
-- =========================================================
CREATE TABLE IF NOT EXISTS public.tasks (
  id             uuid PRIMARY KEY DEFAULT gen_random_uuid(),
  created_at     timestamptz NOT NULL DEFAULT now(),
  updated_at     timestamptz NOT NULL DEFAULT now(),

  contact_id     uuid REFERENCES public.contacts(id) ON DELETE SET NULL,
  lead_id        uuid REFERENCES public.leads(id) ON DELETE SET NULL,
  assigned_to    uuid,

  title          text NOT NULL,
  scheduled_at   timestamptz,      -- appointment
  due_at         timestamptz,      -- callback/task due
  completed_at   timestamptz,

  status         text DEFAULT 'open' CHECK (status IN ('open','completed','cancelled')),
  channel        text,             -- 'call','zoom','in_person'
  metadata       jsonb DEFAULT '{}'::jsonb
);

CREATE INDEX IF NOT EXISTS idx_tasks_assigned_to  ON public.tasks (assigned_to);
CREATE INDEX IF NOT EXISTS idx_tasks_scheduled_at ON public.tasks (scheduled_at);

DROP TRIGGER IF EXISTS trg_tasks_touch ON public.tasks;
CREATE TRIGGER trg_tasks_touch
BEFORE UPDATE ON public.tasks
FOR EACH ROW EXECUTE FUNCTION public.tg_touch_updated_at();

-- =========================================================
-- IMPORTS (upload file → importer does the work)
-- =========================================================
CREATE TABLE IF NOT EXISTS public.import_runs (
  id             uuid PRIMARY KEY DEFAULT gen_random_uuid(),
  created_at     timestamptz NOT NULL DEFAULT now(),
  created_by     uuid,
  source_name    text NOT NULL,         -- 'Lincoln Heritage portal','IMO export', etc.
  file_path      text NOT NULL,         -- Supabase Storage path/URL
  file_type      text,                  -- 'csv','xlsx','pdf'
  carrier_name   text,
  row_count      int,
  status         text NOT NULL DEFAULT 'pending' CHECK (status IN ('pending','processing','completed','failed')),
  notes          text,
  meta           jsonb DEFAULT '{}'::jsonb
);

CREATE INDEX IF NOT EXISTS idx_impruns_created_at ON public.import_runs (created_at);
CREATE INDEX IF NOT EXISTS idx_impruns_status     ON public.import_runs (status);

CREATE TABLE IF NOT EXISTS public.import_rows (
  id               bigserial PRIMARY KEY,
  import_id        uuid NOT NULL REFERENCES public.import_runs(id) ON DELETE CASCADE,
  raw_payload      jsonb NOT NULL,
  processed        boolean DEFAULT false,
  error_message    text,
  linked_policy_id uuid
);

CREATE INDEX IF NOT EXISTS idx_improws_import ON public.import_rows (import_id);
</html>
