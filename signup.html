<script type="module">
  import { createClient } from 'https://cdn.jsdelivr.net/npm/@supabase/supabase-js/+esm';

  const supabase = createClient(
    'https://ddlbgkolnayqrxslzsxn.supabase.co',
    'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6ImRkbGJna29sbmF5cXJ4c2x6c3huIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NDg4Mjg0OTQsImV4cCI6MjA2NDQwNDQ5NH0.-L0N2cuh0g-6ymDyClQbM8aAuldMQzOb3SXV5TDT5Ho'
  );

  const form = document.getElementById('signup-form');
  const status = document.getElementById('status');
  const message = document.getElementById('message');

  form.addEventListener('submit', async (event) => {
    event.preventDefault();
    status.textContent = '⏳ Signing up...';
    message.textContent = '';

    const agentId   = document.getElementById('agent-id').value.trim();
    const firstName = document.getElementById('first-name').value.trim();
    const lastName  = document.getElementById('last-name').value.trim();
    const email     = document.getElementById('email').value.trim();
    const password  = document.getElementById('password').value;
    const confirmPw = document.getElementById('confirm-password').value;

    if (!agentId || !firstName || !lastName || !email || !password) {
      status.textContent = '⚠️ Fill out all fields.'; return;
    }
    if (password !== confirmPw) {
      status.textContent = '⚠️ Passwords do not match.'; return;
    }

    // Check pre-approval (public/anon SELECT allowed by your policies)
    const { data: approved, error: checkErr } = await supabase
      .from('approved_agents')
      .select('id, is_registered')
      .eq('agent_id', agentId)
      .maybeSingle();

    if (checkErr || !approved || approved.is_registered) {
      status.textContent = '❌ Invalid or already registered agent ID.'; return;
    }

    // Create auth user; trigger will create agents row & flip approved_agents
    const { error: signUpError } = await supabase.auth.signUp({
      email, password,
      options: {
        emailRedirectTo: 'https://familyvaluesgroup.com/confirmed.html',
        data: { agent_id: agentId, first_name: firstName, last_name: lastName }
      }
    });

    if (signUpError) {
      status.textContent = '❌ Signup failed: ' + signUpError.message; return;
    }

    status.textContent = '✅ All set. Check your email to confirm your account.';
  });
</script>
