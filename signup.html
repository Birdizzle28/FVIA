<!doctype html>
<html lang="en">
<head>
	<meta charset="utf-8">
	<meta http-equiv="X-UA-Compatible" content="IE=edge">
	<meta name="viewport" content="width=device-width, initial-scale=1.0">
	<link rel="stylesheet" href="styles/general.css">
	<link rel="stylesheet" href="styles/login.css">
	<link href="https://fonts.googleapis.com/css?family=Bellota+Text" rel="stylesheet">
	<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.0/css/all.min.css">
	<title>Sign Up | Family Values Group</title>
</head>
<body id="indexbody">
	<div class="index-body">
		<header class="index-grid-header">
			<a href="index.html"><img id="headerlogo" src="Pics/img6.png" alt=""></a>
			<p><strong>Family Values Group</strong></p>
			<button id="menu-toggle" aria-label="Toggle menu">
		 		<i class="fas fa-bars"></i>
		        </button>
			<hr>
			<nav class="header-flex-container">
				<a href="about.html">About</a>
				<a href="contact.html">Support</a>
				<a href="index.html">Home</a>
				<a href="careers.html">Careers</a>
				<a href="login.html">Login</a>
			</nav>
			<hr>
		</header>
		<div id="mobile-menu">
		    <a href="about.html">About</a>
		    <a href="contact.html">Support</a>
		    <a href="index.html">Home</a>
		    <a href="careers.html">Careers</a>
		    <a href="login.html">Login</a>
		</div>
	<div class="auth-container">
		<h2>Agent Sign-Up</h2>
		<form id="signup-form">
		  <!-- Agent ID (NPN) -->
		  <div class="float-field">
		    <input id="agent-id" type="text" placeholder=" " required>
		    <label for="agent-id">Agent ID (NPN)</label>
		  </div>
			<!-- SSN (for 1099) -->
		<div class="float-field pw-field">
		  <input id="ssn" type="password" placeholder=" " inputmode="numeric" autocomplete="off" required>
		  <label for="ssn">SSN</label>
		  <button type="button" class="pw-toggle" aria-label="Show SSN">
			<i class="fa-regular fa-eye"></i>
		  </button>
		</div>
		  <!-- Password -->
		  <div class="float-field pw-field">
		    <input id="password" type="password" placeholder=" " required>
		    <label for="password">Password</label>
		    <button type="button" class="pw-toggle" aria-label="Show password">
		      <i class="fa-regular fa-eye"></i>
		    </button>
		  </div>
		
		  <!-- Confirm Password -->
		  <div class="float-field pw-field">
		    <input id="confirm-password" type="password" placeholder=" " required>
		    <label for="confirm-password">Confirm Password</label>
		    <button type="button" class="pw-toggle" aria-label="Show password">
		      <i class="fa-regular fa-eye"></i>
		    </button>
		  </div>
		
		  <button type="submit">Sign Up</button>
		</form>
		<p class="switch-auth">Already have an account? <a href="login.html">Sign in here</a>.</p>
		<p id="status">Activating your account…</p>
		<p id="message"></p>
	</div>
	<footer class="index-grid-footer">
		<img id="footerlogo" src="Pics/img6.png">
		<hr class="footerhr">
		<div id="footercontact">
			<a class="contactcontainer" href="mailto:info@familyvaluesgroup.com">
				<span class="fa fa-envelope"></span>
				<span class="contactcontcontacts">info@familyvaluesgroup.com</span>
			</a>
			<p> | </p>
			<a class="contactcontainer" href="tel:+16292437980">
				<span class="fa fa-phone"></span>
				<span class="contactcontcontacts">+1-629-243-7980</span>
			</a>
		</div>
		<hr class="footerhr">
		<div id="footersocial">
			<a class="fab fa-facebook-f" href="https://www.facebook.com/familyvaluesgroup"></a>
			<a class="fab fa-linkedin-in" href="https://www.linkedin.com/in/demisi-johnson-026227391?utm_source=share&utm_campaign=share_via&utm_content=profile&utm_medium=ios_app"></a>
			<a class="fab fa-instagram" href="https://www.instagram.com/family.values.group?igsh=OHl3dGdnd3RwMTV0&utm_source=qr"></a>
			<a class="fab fa-youtube" href="https://youtube.com/@familyvaluesgroup?si=mauqWp5nxyczgCJd"></a>
			<a class="fab fa-google" href="https://g.page/r/CXUiEg9T9xHSEAE/review"></a>
		</div>
		<div id="footerlinks">
			<a href="faqs.html">FAQs</a>
			<a href="terms.html">Terms</a>
			<a href="accessibility.html">Accessibility</a>
			<a href="privacy.html">Privacy</a>
		</div>
		<p><em>© 2025 Family Values Group. All Rights Reserved.</em></p>
	</footer>
	<script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2/dist/umd/supabase.js"></script>
	<script src="scripts/supabase-client.js"></script>
	<script src="scripts/general.js"></script>
	<script>
	  // Toggle show/hide for password fields
	  document.addEventListener('click', (e) => {
	    const btn = e.target.closest('.pw-toggle');
	    if (!btn) return;
	    const input = btn.parentElement.querySelector('input');
	    const icon  = btn.querySelector('i');
	    const isText = input.type === 'text';
	    input.type = isText ? 'password' : 'text';
	    btn.setAttribute('aria-label', isText ? 'Show password' : 'Hide password');
	    icon.classList.toggle('fa-eye');
	    icon.classList.toggle('fa-eye-slash');
	  });
	</script>
    <script>
	  const supabase = window.supabaseClient;
	
	  const form    = document.getElementById('signup-form');
	  const status  = document.getElementById('status');
	  const message = document.getElementById('message');
	
	  form.addEventListener('submit', async (event) => {
	    event.preventDefault();
	    status.textContent  = '⏳ Signing up...';
	    message.textContent = '';
	
	    const agentId   = document.getElementById('agent-id').value.trim();
	    const password  = document.getElementById('password').value;
	    const confirmPw = document.getElementById('confirm-password').value;
		const ssnRaw = document.getElementById('ssn').value.trim();
		const ssnDigits = ssnRaw.replace(/\D/g, '');
		if (ssnDigits.length !== 9) {
		  status.textContent = '⚠️ Enter a valid 9-digit SSN.';
		  return;
		}
	    if (!agentId || !password) {
	      status.textContent = '⚠️ Enter your Agent ID and password.';
	      return;
	    }
	    if (password !== confirmPw) {
	      status.textContent = '⚠️ Passwords do not match.';
	      return;
	    }
	
	    // 1) Look up the pre-approved record
	    const { data: approved, error: checkErr } = await supabase
	      .from('approved_agents')
	      .select(`
	        id,
	        agent_id,
	        is_registered,
	        email,
	        first_name,
	        last_name,
	        phone,
	        level,
	        recruiter_id,
  			stripe_account_id
	      `)
	      .eq('agent_id', agentId)
	      .maybeSingle();
	
	    if (checkErr) {
	      console.error('Error checking approved_agents:', checkErr);
	      status.textContent = '❌ Error checking agent ID. Please contact support.';
	      return;
	    }
	
	    if (!approved) {
	      status.textContent =
	        '❌ Agent ID not found. Ask your upline or admin to pre-approve you first.';
	      return;
	    }
	
	    if (approved.is_registered) {
	      status.textContent =
	        '❌ This agent ID is already registered. Try logging in instead.';
	      return;
	    }
	
	    if (!approved.email) {
	      status.textContent =
	        '⚠️ No email is on file for this contract. Please contact an admin to fix your pre-approval.';
	      return;
	    }
	
	    const authEmail = approved.email.trim();
	    const metaFirst = approved.first_name || '';
	    const metaLast  = approved.last_name || '';
	    const metaPhone = approved.phone || null;
	
	    // 2) Create the auth user using the email from approved_agents
	    const { data: signUpData, error: signUpError } = await supabase.auth.signUp({
	      email: authEmail,
	      password,
	      options: {
	        emailRedirectTo: 'https://familyvaluesgroup.com/confirmed.html',
	        data: {
	          agent_id: approved.agent_id,
	          first_name: metaFirst,
	          last_name: metaLast,
	          phone: metaPhone,
	          level: approved.level || null,
	          recruiter_id: approved.recruiter_id || null
	        }
	      }
	    });
	
	    if (signUpError) {
	      console.error('signUp error:', signUpError);
	      status.textContent = '❌ Signup failed: ' + signUpError.message;
	      return;
	    }
		const newUserId = signUpData?.user?.id;
		if (!newUserId) {
		  status.textContent = '❌ Signup created, but missing user id. Contact support.';
		  return;
		}
		
		try {
		  const ssnRes = await fetch('/.netlify/functions/storeSignupSSN', {
			method: 'POST',
			headers: { 'Content-Type': 'application/json' },
			body: JSON.stringify({
			  agent_id: approved.agent_id,
			  email: authEmail,
			  user_id: newUserId,
			  ssn: ssnDigits
			})
		  });
		
		  const ssnText = await ssnRes.text();
		  if (!ssnRes.ok) {
			console.error('storeSignupSSN failed:', ssnText);
			status.textContent = '❌ Signup created, but SSN storage failed. Contact admin.';
			return;
		  }
		} catch (e) {
		  console.error('storeSignupSSN error:', e);
		  status.textContent = '❌ Signup created, but SSN storage failed. Contact admin.';
		  return;
		}
	    // At this point, auth user creation worked. Everything else is bookkeeping.
	
	    // 3) Ensure agents row exists / is active
	    try {
	      const { data: existingAgent, error: agentCheckErr } = await supabase
	        .from('agents')
	        .select('id')
	        .eq('agent_id', approved.agent_id)
	        .maybeSingle();
	
	      if (agentCheckErr) {
	        console.error('Error checking agents table:', agentCheckErr);
	      } else if (!existingAgent) {
	        const fullName = [approved.first_name, approved.last_name]
	          .filter(Boolean)
	          .join(' ') || approved.agent_id;
	
	        const agentPayload = {
				id: newUserId,
	          email: authEmail,
	          agent_id: approved.agent_id,
			  stripe_account_id: approved.stripe_account_id || null,
	          full_name: fullName,
	          first_name: approved.first_name || null,
	          last_name: approved.last_name || null,
	          phone: approved.phone || null,
	          recruiter_id: approved.recruiter_id || null,
	          level: approved.level || null,
	          is_active: true,
	          is_admin: false,
	          show_on_about: false,
	          profile_picture_url: null,
	          companies: null,
	          product_types: null,
	          licensed_states_by_line: {},   // default '{}'
	          is_available: false,
	          created_at: new Date().toISOString()
	        };
	
	        const { error: agentInsertErr } = await supabase
	          .from('agents')
	          .insert(agentPayload);
	
	        if (agentInsertErr) {
	          console.error('Error inserting into agents:', agentInsertErr);
	        }
	      } else {
	        // Optional: make sure existing agent is marked active
	        const { error: agentUpdateErr } = await supabase
	          .from('agents')
	          .update({ is_active: true })
	          .eq('id', existingAgent.id);
	
	        if (agentUpdateErr) {
	          console.error('Error updating existing agent row:', agentUpdateErr);
	        }
	      }
	    } catch (err) {
	      console.error('Unexpected error handling agents table:', err);
	    }
	
	    // 4) Flip approved_agents flags → registered + onboarding_stage
	    try {
	      const { error: approvedUpdateErr } = await supabase
	        .from('approved_agents')
	        .update({
	          is_registered: true,
	          onboarding_stage: 'signup_completed'
	        })
	        .eq('id', approved.id);
	
	      if (approvedUpdateErr) {
	        console.error('Error updating approved_agents after signup:', approvedUpdateErr);
	      }
	    } catch (err) {
	      console.error('Unexpected error updating approved_agents:', err);
	    }
	
	    // 5) Best-effort: update recruits.stage → 'agent'
	    try {
	      if (approved.first_name && approved.last_name && approved.recruiter_id) {
	        const { error: recruitErr } = await supabase
	          .from('recruits')
	          .update({
	            stage: 'agent',
	            stage_updated_at: new Date().toISOString()
	          })
	          .eq('recruiter_id', approved.recruiter_id)
	          .eq('first_name', approved.first_name)
	          .eq('last_name', approved.last_name);
	
	        if (recruitErr) {
	          console.error('Error updating recruits.stage to agent:', recruitErr);
	        }
	      }
	    } catch (err) {
	      console.error('Unexpected error updating recruits:', err);
	    }
	
	    status.textContent =
	      '✅ Account created. Check ' + authEmail + ' to confirm your account.';
	  });
	</script>
</body>
</html>
