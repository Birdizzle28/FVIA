<!doctype html>
<html lang="en">
<head>
	<meta charset="utf-8">
	<meta http-equiv="X-UA-Compatible" content="IE=edge">
	<meta name="viewport" content="width=device-width, initial-scale=1.0">
	<link rel="stylesheet" href="styles/general.css">
	<link rel="stylesheet" href="styles/login.css">
	<link href="https://fonts.googleapis.com/css?family=Bellota+Text" rel="stylesheet">
	<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.0/css/all.min.css">
	<title>Sign Up | Family Values Group</title>
</head>
<body id="indexbody">
	<div class="index-body">
		<header class="index-grid-header">
			<a href="index.html"><img id="headerlogo" src="Pics/img6.png" alt=""></a>
			<p><strong>Family Values Group</strong></p>
			<button id="menu-toggle" aria-label="Toggle menu">
		 		<i class="fas fa-bars"></i>
		        </button>
			<hr>
			<nav class="header-flex-container">
				<a href="about.html">About</a>
				<a href="contact.html">Support</a>
				<a href="index.html">Home</a>
				<a href="careers.html">Careers</a>
				<a href="login.html">Login</a>
			</nav>
			<hr>
		</header>
		<div id="mobile-menu">
		    <a href="about.html">About</a>
		    <a href="contact.html">Support</a>
		    <a href="index.html">Home</a>
		    <a href="careers.html">Careers</a>
		    <a href="login.html">Login</a>
		</div>
	<div class="auth-container">
		<h2>Agent Sign-Up</h2>
		<form id="signup-form">
		  <!-- First Name -->
		  <div class="float-field">
		    <input id="first-name" type="text" placeholder=" " required>
		    <label for="first-name">First Name</label>
		  </div>
		
		  <!-- Last Name -->
		  <div class="float-field">
		    <input id="last-name" type="text" placeholder=" " required>
		    <label for="last-name">Last Name</label>
		  </div>
		
		  <!-- Agent ID (NPN) -->
		  <div class="float-field">
		    <input id="agent-id" type="text" placeholder=" " required>
		    <label for="agent-id">Agent ID (NPN)</label>
		  </div>
		
		  <!-- Email -->
		  <div class="float-field">
		    <input id="email" type="email" placeholder=" " required>
		    <label for="email">Email (used as username)</label>
		  </div>
		
		  <!-- Password -->
		  <div class="float-field pw-field">
		    <input id="password" type="password" placeholder=" " required>
		    <label for="password">Password</label>
		    <button type="button" class="pw-toggle" aria-label="Show password">
		      <i class="fa-regular fa-eye"></i>
		    </button>
		  </div>
		
		  <!-- Confirm Password -->
		  <div class="float-field pw-field">
		    <input id="confirm-password" type="password" placeholder=" " required>
		    <label for="confirm-password">Confirm Password</label>
		    <button type="button" class="pw-toggle" aria-label="Show password">
		      <i class="fa-regular fa-eye"></i>
		    </button>
		  </div>
		
		  <button type="submit">Sign Up</button>
		</form>
		<p class="switch-auth">Already have an account? <a href="login.html">Sign in here</a>.</p>
		<p id="status">Activating your account‚Ä¶</p>
		<p id="message"></p>
	</div>
	<footer class="index-grid-footer">
		<img id="footerlogo" src="Pics/img6.png">
		<hr class="footerhr">
		<div id="footercontact">
			<a class="contactcontainer" href="mailto:info@familyvaluesgroup.com">
				<span class="fa fa-envelope"></span>
				<span class="contactcontcontacts">info@familyvaluesgroup.com</span>
			</a>
			<p> | </p>
			<a class="contactcontainer" href="tel:+16292437980">
				<span class="fa fa-phone"></span>
				<span class="contactcontcontacts">+1-629-243-7980</span>
			</a>
		</div>
		<hr class="footerhr">
		<div id="footersocial">
			<a class="fab fa-facebook-f" href="https://www.facebook.com/familyvaluesgroup"></a>
			<a class="fab fa-linkedin-in" href="https://www.linkedin.com/in/demisi-johnson-026227391?utm_source=share&utm_campaign=share_via&utm_content=profile&utm_medium=ios_app"></a>
			<a class="fab fa-instagram" href="https://www.instagram.com/family.values.group?igsh=OHl3dGdnd3RwMTV0&utm_source=qr"></a>
			<a class="fab fa-youtube" href="https://youtube.com/@familyvaluesgroup?si=mauqWp5nxyczgCJd"></a>
			<a class="fab fa-google" href="https://g.page/r/CXUiEg9T9xHSEAE/review"></a>
		</div>
		<div id="footerlinks">
			<a href="faqs.html">FAQs</a>
			<a href="terms.html">Terms</a>
			<a href="accessibility.html">Accessibility</a>
			<a href="privacy.html">Privacy</a>
		</div>
		<p><em>¬© 2025 Family Values Group. All Rights Reserved.</em></p>
	</footer>
	<script type="module" src="scripts/general.js"></script>
	<script>
	  // Toggle show/hide for password fields
	  document.addEventListener('click', (e) => {
	    const btn = e.target.closest('.pw-toggle');
	    if (!btn) return;
	    const input = btn.parentElement.querySelector('input');
	    const icon  = btn.querySelector('i');
	    const isText = input.type === 'text';
	    input.type = isText ? 'password' : 'text';
	    btn.setAttribute('aria-label', isText ? 'Show password' : 'Hide password');
	    icon.classList.toggle('fa-eye');
	    icon.classList.toggle('fa-eye-slash');
	  });
	</script>
  <script type="module">
	  import { createClient } from 'https://cdn.jsdelivr.net/npm/@supabase/supabase-js/+esm';
	  
	  const supabase = createClient(
	    'https://ddlbgkolnayqrxslzsxn.supabase.co',
	    'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6ImRkbGJna29sbmF5cXJ4c2x6c3huIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NDg4Mjg0OTQsImV4cCI6MjA2NDQwNDQ5NH0.-L0N2cuh0g-6ymDyClQbM8aAuldMQzOb3SXV5TDT5Ho'
	  );
	  
	  const form = document.getElementById('signup-form');
	  const status = document.getElementById('status');
	  const message = document.getElementById('message');
	  
	  form.addEventListener('submit', async (event) => {
	    event.preventDefault();
	    status.textContent = '‚è≥ Signing up...';
	    message.textContent = '';
	  
	    const agentId   = document.getElementById('agent-id').value.trim();
	    const firstName = document.getElementById('first-name').value.trim();
	    const lastName  = document.getElementById('last-name').value.trim();
	    const email     = document.getElementById('email').value.trim();
	    const password  = document.getElementById('password').value;
	    const confirmPw = document.getElementById('confirm-password').value;
	  
	    if (!agentId || !firstName || !lastName || !email || !password) {
	      status.textContent = '‚ö†Ô∏è Fill out all fields.';
	      return;
	    }
	    if (password !== confirmPw) {
	      status.textContent = '‚ö†Ô∏è Passwords do not match.';
	      return;
	    }

		// üîÅ 1) Sync ICA status from SignWell into Supabase
		  try {
		    await fetch('/.netlify/functions/sync-ica-status', {
		      method: 'POST',
		      headers: { 'Content-Type': 'application/json' },
		      body: JSON.stringify({ agent_id: agentId })
		    });
		    // we don't even have to read the response; we just want Supabase updated
		  } catch (err) {
		    console.error('sync-ica-status error (frontend):', err);
		    // Don't hard-fail signup here ‚Äî we still rely on the DB values below.
		  }

	    // Check pre-approval AND ICA status
	    const { data: approved, error: checkErr } = await supabase
	      .from('approved_agents')
	      .select('id, is_registered, ica_signed, ica_status, level, recruiter_id, email, first_name, last_name')
	      .eq('agent_id', agentId)
	      .maybeSingle();
	  
	    if (checkErr) {
	      console.error('Error checking approved_agents:', checkErr);
	      status.textContent = '‚ùå Error checking agent ID. Please contact support.';
	      return;
	    }
	  
	    if (!approved) {
	      status.textContent = '‚ùå Agent ID not found. Ask your upline or admin to pre-approve you.';
	      return;
	    }
	  
	    if (approved.is_registered) {
	      status.textContent = '‚ùå This agent ID is already registered. Try logging in instead.';
	      return;
	    }
	  
	    // Enforce "ICA must be signed" rule
	    const isSigned = approved.ica_signed === true || (approved.ica_status || '').toLowerCase() === 'completed';
	    if (!isSigned) {
	      status.textContent = '‚ö†Ô∏è Your Independent Contractor Agreement is not marked as signed yet. Please complete the contract that was emailed to you or contact your upline.';
	      return;
	    }
	  
	    // Optional sanity check: if we have an email on file and it doesn't match, warn
	    if (approved.email && approved.email.toLowerCase() !== email.toLowerCase()) {
	      status.textContent = '‚ö†Ô∏è Use the same email we have on file for your contract, or contact an admin.';
	      return;
	    }
	  
	    // Create auth user; metadata includes agent & level info
	    const { error: signUpError } = await supabase.auth.signUp({
	      email,
	      password,
	      options: {
	        emailRedirectTo: 'https://familyvaluesgroup.com/confirmed.html',
	        data: {
	          agent_id: agentId,
	          first_name: firstName,
	          last_name: lastName,
	          level: approved.level || null,
	          recruiter_id: approved.recruiter_id || null
	        }
	      }
	    });
	  
	    if (signUpError) {
	      status.textContent = '‚ùå Signup failed: ' + signUpError.message;
	      return;
	    }
	  
	    status.textContent = '‚úÖ All set. Check your email to confirm your account.';
	  });
	</script>
</body>
</html>
