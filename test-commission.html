<!DOCTYPE html>
<html>
<head>
  <meta charset="UTF-8">
  <title>Commission System Tester</title>
</head>
<body>
  <h1>Commission System Tester</h1>

  <!-- --------------------- -->
  <!--  PROCESS COMMISSION   -->
  <!-- --------------------- -->
  <h2>Run processPolicyCommission</h2>

  <label>
    Policy ID:<br>
    <input id="policy-id" type="text" style="width: 340px;">
  </label>
  <button id="run-commission-btn">Run Commission</button>

  <pre id="commission-output" style="white-space: pre-wrap; background:#111; color:#0f0; padding:10px; margin-top:20px; min-height:120px;"></pre>


  <!-- --------------------- -->
  <!--  RUN WEEKLY ADVANCE   -->
  <!-- --------------------- -->
  <h2>Run Weekly Advance Payout</h2>

  <label>
    <strong>Optional:</strong> Test Pay Date (YYYY-MM-DD)<br>
    <input id="pay-date" type="text" style="width: 200px;" placeholder="(leave blank for automatic)">
  </label>
  <button id="run-weekly-btn">Run Weekly Advance</button>

  <pre id="weekly-output" style="white-space: pre-wrap; background:#111; color:#0af; padding:10px; margin-top:20px; min-height:120px;"></pre>


  <!-- -------------------------- -->
  <!--  RUN MONTHLY PAY-THRU     -->
  <!-- -------------------------- -->
  <h2>Run Monthly Pay-Thru Payout</h2>

  <label>
    <strong>Optional:</strong> Pay Date (YYYY-MM-DD)<br>
    <input id="paythru-date" type="text" style="width: 200px;" placeholder="2025-12-31">
  </label>
  <button id="run-paythru-btn">Run Monthly Pay-Thru</button>

  <pre id="paythru-output" style="white-space: pre-wrap; background:#111; color:#0f0; padding:10px; margin-top:20px; min-height:120px;"></pre>
  <button id="send-batch-btn">Preview Stripe Payouts</button>
<input id="batch-id" placeholder="Paste payout_batches.id">
<!-- -------------------------- -->
<!--  CREATE STRIPE ACCOUNT    -->
<!-- -------------------------- -->
<h2>Create Stripe Account for Pre-Approved Agent</h2>

<label>
  NPN:<br>
  <input id="npn-input" type="text" style="width: 200px;" placeholder="Agent NPN">
</label>
<button id="create-stripe-btn">Create Stripe Account + Get Onboarding Link</button>

<pre id="stripe-output" style="white-space: pre-wrap; background:#111; color:#ff0; padding:10px; margin-top:20px; min-height:120px;"></pre>
<!-- -------------------------- -->
<!--  SEND TEST STRIPE TRANSFER -->
<!-- -------------------------- -->
<h2>Send Test Stripe Transfer (Platform ➜ Connected)</h2>

<label>
  Connected Account ID (acct_...):<br>
  <input id="test-dest-acct" type="text" style="width: 340px;" placeholder="acct_1234...">
</label>
<br><br>
<label>
  Amount (USD):<br>
  <input id="test-amount" type="number" step="0.01" min="0.01" style="width: 200px;" placeholder="10.00">
</label>
<br><br>

<!-- Optional: force payout to connected bank (if available in test) -->
<label>
  <input id="test-force-payout" type="checkbox">
  Also create payout from connected account (Connected ➜ Bank)
</label>
<br><br>

<button id="send-test-transfer-btn">Send Test Transfer</button>

<pre id="test-transfer-output" style="white-space: pre-wrap; background:#111; color:#0ff; padding:10px; margin-top:20px; min-height:120px;"></pre>

<!-- -------------------------- -->
<!--  RESEND STRIPE ONBOARDING  -->
<!-- -------------------------- -->
<h2>Resend Stripe Onboarding Link (Account Links API)</h2>

<label>
  Connected Account ID (acct_...):<br>
  <input id="onboard-acct-id" type="text" style="width: 340px;" placeholder="acct_1234...">
</label>
<br><br>

<label>
  Return URL (optional):<br>
  <input id="onboard-return-url" type="text" style="width: 500px;" placeholder="(leave blank to use server default)">
</label>
<br><br>

<label>
  Refresh URL (optional):<br>
  <input id="onboard-refresh-url" type="text" style="width: 500px;" placeholder="(leave blank to use server default)">
</label>
<br><br>

<button id="create-onboarding-link-btn">Generate New Onboarding Link</button>

<pre id="onboarding-link-output" style="white-space: pre-wrap; background:#111; color:#ffb; padding:10px; margin-top:20px; min-height:120px;"></pre>

<script>
document.getElementById('create-onboarding-link-btn').addEventListener('click', async () => {
  const acctId = document.getElementById('onboard-acct-id').value.trim();
  const returnUrl = document.getElementById('onboard-return-url').value.trim();
  const refreshUrl = document.getElementById('onboard-refresh-url').value.trim();
  const out = document.getElementById('onboarding-link-output');

  if (!acctId || !acctId.startsWith('acct_')) {
    alert('Paste a valid connected account id (acct_...)');
    return;
  }

  out.textContent = 'Generating onboarding link...';

  try {
    const res = await fetch('/.netlify/functions/createOnboardingLink', {
      method: 'POST',
      headers: { 'Content-Type': 'application/json' },
      body: JSON.stringify({
        account_id: acctId,
        return_url: returnUrl || undefined,
        refresh_url: refreshUrl || undefined
      })
    });

    const text = await res.text();

    // Try JSON pretty print
    try {
      const json = JSON.parse(text);
      out.textContent = `Status: ${res.status}\n\n` + JSON.stringify(json, null, 2);

      if (json.url) {
        out.textContent += `\n\nOnboarding URL:\n${json.url}`;
      }
    } catch {
      out.textContent = `Status: ${res.status}\n\n${text}`;
    }
  } catch (err) {
    out.textContent = 'Error: ' + err.message;
  }
});
</script>

<script>
document.getElementById('send-test-transfer-btn').addEventListener('click', async () => {
  const acct = document.getElementById('test-dest-acct').value.trim();
  const amt  = document.getElementById('test-amount').value.trim();
  const forcePayout = document.getElementById('test-force-payout').checked;
  const out  = document.getElementById('test-transfer-output');

  if (!acct) return alert('Enter a connected account id (acct_...)');
  if (!amt || Number(amt) <= 0) return alert('Enter a valid amount');

  out.textContent = 'Sending test transfer...';

  try {
    const res = await fetch('/.netlify/functions/sendTestTransfer', {
      method: 'POST',
      headers: { 'Content-Type': 'application/json' },
      body: JSON.stringify({
        destination_account_id: acct,
        amount: Number(amt),
        force_payout: forcePayout
      })
    });

    const text = await res.text();
    out.textContent = `Status: ${res.status}\n\n${text}`;
  } catch (err) {
    out.textContent = 'Error: ' + err.message;
  }
});
</script>
<script>
  document.getElementById('send-batch-btn').addEventListener('click', async () => {
  const batchId = document.getElementById('batch-id').value.trim();
  if (!batchId) return alert('Paste a batch id');
  const res = await fetch('/.netlify/functions/sendPayoutBatch', {
    method: 'POST',
    headers: { 'Content-Type': 'application/json' },
    body: JSON.stringify({ batch_id: batchId })
  });
  console.log(await res.text());
});
</script>


<script>
/* =======================================================
   RUN processPolicyCommission
   ======================================================= */
document.getElementById('run-commission-btn').addEventListener('click', async () => {
  const policyId = document.getElementById('policy-id').value.trim();
  const out = document.getElementById('commission-output');
  out.textContent = 'Running...';

  if (!policyId) {
    out.textContent = 'Please enter a policy_id first.';
    return;
  }

  try {
    const res = await fetch('/.netlify/functions/processPolicyCommission', {
      method: 'POST',
      headers: { 'Content-Type': 'application/json' },
      body: JSON.stringify({ policy_id: policyId })
    });

    const text = await res.text();
    out.textContent = `Status: ${res.status}\n\n${text}`;
  } catch (err) {
    out.textContent = 'Error: ' + err.message;
  }
});


/* =======================================================
   RUN runWeeklyAdvance.js
   ======================================================= */
document.getElementById('run-weekly-btn').addEventListener('click', async () => {
  const payDate = document.getElementById('pay-date').value.trim();
  const out = document.getElementById('weekly-output');
  out.textContent = 'Running weekly advance...';

  let url = '/.netlify/functions/runWeeklyAdvance';
  if (payDate) {
    url += `?pay_date=${encodeURIComponent(payDate)}`;
  }

  try {
    const res = await fetch(url, {
      method: 'POST'
    });

    const text = await res.text();
    out.textContent = `Status: ${res.status}\n\n${text}`;
  } catch (err) {
    out.textContent = 'Error: ' + err.message;
  }
});


/* =======================================================
   RUN runMonthlyPayThru.js
   ======================================================= */
document.getElementById('run-paythru-btn').addEventListener('click', async () => {
  const date = document.getElementById('paythru-date').value.trim();
  const out = document.getElementById('paythru-output');
  out.textContent = 'Running monthly pay-thru...';

  let url = '/.netlify/functions/runMonthlyPayThru';
  if (date) {
    url += `?pay_date=${encodeURIComponent(date)}`;
  }

  try {
    const res = await fetch(url, {
      method: 'POST'
    });

    const text = await res.text();
    out.textContent = `Status: ${res.status}\n\n${text}`;
  } catch (err) {
    out.textContent = 'Error: ' + err.message;
  }
});
/* =======================================================
   CREATE STRIPE CONNECT ACCOUNT USING NPN
   ======================================================= */
document.getElementById('create-stripe-btn').addEventListener('click', async () => {
  const npn = document.getElementById('npn-input').value.trim();
  const out = document.getElementById('stripe-output');

  if (!npn) {
    out.textContent = 'Please enter an NPN.';
    return;
  }

  out.textContent = 'Calling createStripeAccount…';

  try {
    const res = await fetch('/.netlify/functions/createStripeAccount', {
      method: 'POST',
      headers: { 'Content-Type': 'application/json' },
      body: JSON.stringify({ npn })
    });

    const text = await res.text();

    try {
      const json = JSON.parse(text);
      out.textContent =
        'Status: ' + res.status + '\n\n' +
        JSON.stringify(json, null, 2);

      if (json.onboarding_url) {
        out.textContent +=
          '\n\nOnboarding URL:\n' +
          json.onboarding_url;
      }
    } catch {
      out.textContent = 'Status: ' + res.status + '\n\n' + text;
    }
  } catch (err) {
    out.textContent = 'Error: ' + err.message;
  }
});

</script>

</body>
</html>
