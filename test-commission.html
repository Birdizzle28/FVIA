<!DOCTYPE html>
<html>
<head>
  <meta charset="UTF-8">
  <title>Commission System Tester</title>
</head>
<body>
  <h1>Commission System Tester</h1>

  <!-- --------------------- -->
  <!--  PROCESS COMMISSION   -->
  <!-- --------------------- -->
  <h2>Run processPolicyCommission</h2>

  <label>
    Policy ID:<br>
    <input id="policy-id" type="text" style="width: 340px;">
  </label>
  <button id="run-commission-btn">Run Commission</button>

  <pre id="commission-output" style="white-space: pre-wrap; background:#111; color:#0f0; padding:10px; margin-top:20px; min-height:120px;"></pre>


  <!-- --------------------- -->
  <!--  RUN WEEKLY ADVANCE   -->
  <!-- --------------------- -->
  <h2>Run Weekly Advance Payout</h2>

  <label>
    <strong>Optional:</strong> Test Pay Date (YYYY-MM-DD)<br>
    <input id="pay-date" type="text" style="width: 200px;" placeholder="(leave blank for automatic)">
  </label>
  <button id="run-weekly-btn">Run Weekly Advance</button>

  <pre id="weekly-output" style="white-space: pre-wrap; background:#111; color:#0af; padding:10px; margin-top:20px; min-height:120px;"></pre>


  <!-- -------------------------- -->
  <!--  RUN MONTHLY PAY-THRU     -->
  <!-- -------------------------- -->
  <h2>Run Monthly Pay-Thru Payout</h2>

  <label>
    <strong>Optional:</strong> Pay Date (YYYY-MM-DD)<br>
    <input id="paythru-date" type="text" style="width: 200px;" placeholder="2025-12-31">
  </label>
  <button id="run-paythru-btn">Run Monthly Pay-Thru</button>

  <pre id="paythru-output" style="white-space: pre-wrap; background:#111; color:#0f0; padding:10px; margin-top:20px; min-height:120px;"></pre>
  <button id="send-batch-btn">Preview Stripe Payouts</button>
<input id="batch-id" placeholder="Paste payout_batches.id">
<!-- -------------------------- -->
<!--  CREATE STRIPE ACCOUNT    -->
<!-- -------------------------- -->
<h2>Create Stripe Account for Agent</h2>

<label>
  Agent ID (agents.id UUID):<br>
  <input id="agent-id" type="text" style="width: 340px;" placeholder="paste agents.id here">
</label>
<button id="create-stripe-btn">Create Stripe Account + Get Onboarding Link</button>

<pre id="stripe-output" style="white-space: pre-wrap; background:#111; color:#ff0; padding:10px; margin-top:20px; min-height:120px;"></pre>
<script>
document.getElementById('send-batch-btn').addEventListener('click', async () => {
  const batchId = document.getElementById('batch-id').value.trim();
  if (!batchId) return alert('Paste a batch id');
  const res = await fetch('/.netlify/functions/sendPayoutBatch', {
    method: 'POST',
    headers: { 'Content-Type': 'application/json' },
    body: JSON.stringify({ batch_id: batchId })
  });
  console.log(await res.text());
});
</script>


<script>
/* =======================================================
   RUN processPolicyCommission
   ======================================================= */
document.getElementById('run-commission-btn').addEventListener('click', async () => {
  const policyId = document.getElementById('policy-id').value.trim();
  const out = document.getElementById('commission-output');
  out.textContent = 'Running...';

  if (!policyId) {
    out.textContent = 'Please enter a policy_id first.';
    return;
  }

  try {
    const res = await fetch('/.netlify/functions/processPolicyCommission', {
      method: 'POST',
      headers: { 'Content-Type': 'application/json' },
      body: JSON.stringify({ policy_id: policyId })
    });

    const text = await res.text();
    out.textContent = `Status: ${res.status}\n\n${text}`;
  } catch (err) {
    out.textContent = 'Error: ' + err.message;
  }
});


/* =======================================================
   RUN runWeeklyAdvance.js
   ======================================================= */
document.getElementById('run-weekly-btn').addEventListener('click', async () => {
  const payDate = document.getElementById('pay-date').value.trim();
  const out = document.getElementById('weekly-output');
  out.textContent = 'Running weekly advance...';

  let url = '/.netlify/functions/runWeeklyAdvance';
  if (payDate) {
    url += `?pay_date=${encodeURIComponent(payDate)}`;
  }

  try {
    const res = await fetch(url, {
      method: 'POST'
    });

    const text = await res.text();
    out.textContent = `Status: ${res.status}\n\n${text}`;
  } catch (err) {
    out.textContent = 'Error: ' + err.message;
  }
});


/* =======================================================
   RUN runMonthlyPayThru.js
   ======================================================= */
document.getElementById('run-paythru-btn').addEventListener('click', async () => {
  const date = document.getElementById('paythru-date').value.trim();
  const out = document.getElementById('paythru-output');
  out.textContent = 'Running monthly pay-thru...';

  let url = '/.netlify/functions/runMonthlyPayThru';
  if (date) {
    url += `?pay_date=${encodeURIComponent(date)}`;
  }

  try {
    const res = await fetch(url, {
      method: 'POST'
    });

    const text = await res.text();
    out.textContent = `Status: ${res.status}\n\n${text}`;
  } catch (err) {
    out.textContent = 'Error: ' + err.message;
  }
});
/* =======================================================
   CREATE STRIPE CONNECT ACCOUNT FOR AGENT
   ======================================================= */
document.getElementById('create-stripe-btn').addEventListener('click', async () => {
  const agentIdInput = document.getElementById('agent-id');
  const out = document.getElementById('stripe-output');

  const agent_id = agentIdInput.value.trim();
  if (!agent_id) {
    out.textContent = 'Please paste an agents.id (UUID) from Supabase.';
    return;
  }

  out.textContent = 'Calling createStripeAccountâ€¦';

  try {
    const res = await fetch('/.netlify/functions/createStripeAccount', {
      method: 'POST',
      headers: { 'Content-Type': 'application/json' },
      body: JSON.stringify({ agent_id })
    });

    const text = await res.text();

    // Try to pretty print JSON if possible
    try {
      const json = JSON.parse(text);
      out.textContent =
        'Status: ' + res.status + '\n\n' +
        JSON.stringify(json, null, 2);

      // If we got an onboarding URL, show it nicely
      if (json.onboarding_url) {
        out.textContent +=
          '\n\nOpen this URL to complete onboarding:\n' +
          json.onboarding_url;
      }
    } catch {
      // Not JSON, just show raw text
      out.textContent = 'Status: ' + res.status + '\n\n' + text;
    }
  } catch (err) {
    out.textContent = 'Error: ' + err.message;
  }
});

</script>

</body>
</html>
